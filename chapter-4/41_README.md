## 选择恰当的分片数量和分片副本数量

<div style="text-indent:2em">
<p> 最开始使用ElasticSearch时，一般都是创建一个索引，导入数据，然后发送查询命令检索数据。我们确信系统运行庚子，至少在最开始，数据量不大而且QPS(Query Per Second)也不高的时候运行良好。在幕后，ElasticSearch创建了一些分片来存储数据，也可能还会创建分片副本(例如，如果用默认配置)，而且用户在配置方面也不用过多地操心。</p>

<p>当应用程序规模增长起来，越来越多的数据需要进行索引，QPS也变得越来越高。这个时候，量变就引起质变了。慢慢地问题也就出现了(读者可以阅读 <i>知识的灵活运用</i>一节的内容来了解应用程序规模增长的对应方法) 。这时候，就该思想如何规划索引数据、优化配置使得应用程序的处理能力与规模增长相同步。在本章，作者将给出一些应对相关问题的指导方针。然而对应问题并没有一个统一的标准，不同的应用场景有着不同的特点和需求，这些特点和需求不仅体现在索引结构上，同时也体现在配置上面。例如：整个索引的数据规模、查询类型、预期的吞吐量都是不尽相同的。</p>
<h3 style="text-indent:0em;">分片和过度分配(over allocation)</h3>

<p>
关于索引分片，在<i>第一章&nbsp;&nbsp;认识ElasticSearch</i>里面已经有介绍，这里简单回顾一下。索引分片就是把索引数据切分成多个小的索引块，这些小的索引块能够分发到同一个集群中的不同节点。在检索时，检索的结果是该索引每个分片上检索结果的总和(尽管在某些场景中“总和”并不成立：单个分片有可能存储了所有的目标数据)。默认情况下，ElasticSearch会为每个索引创建5个主分片，就算是单结点集群亦是如此。像这样的冗余就称为过度分配：这种场景下，这种分配方式似乎是多此一举，而且只会在索引数据(把文档分发到多个分片上)和检索(必须从多个分片上查询数据然后全并结果)的时候增加复杂度，乐享其成的是，这些复杂的事情是自动处理的，但是为什么ElasticSearch要这样做呢？</p>
<p>假定我们有一个构建在单个分片上的索引。这意味着如果我们的应用程序规模增长到单机无法处理的情况下时，问题就来了。当索引中有数据时，当前版本的ElasticSearch是无法将分片中的数据切分成多个小块的：我们只能在创建索引的时候指定好分片的数量。唯一的解决办法就是重新创建一份多个分片的索引，然后将原来的数据重新索引(动词)到新的索引(名词)中。然而这样的处理方案需要时间和服务器资源，比如CUP时间、内存、大容量存储器。而且有可能我们并没有时间和上面提到的那些资源。换个角度，通过使用过度分配策略，我们可以在必要的时候添加一台新的安装了ElasticSearch的服务器。当新的节点添加进来时，ElasticSearch会自动对集群进行负载均衡，在不需要重新索引数据的前提下将部分索引数据转移到新的机器上。ElasticSearch作者设置的默认配置(5个主分片和一个分片副本)是权衡了数据增长的可能性和合并不同分片数据的最终开之后的最终选择。</p>
<p>默认配置适用于大部分场合。那么问题来了：当我们在什么时个需要增加或者减少分片数量，让分片数量尽可能少一些？</p>
</div>

